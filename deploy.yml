---
- name: Déployer l'application sur le serveur de production
  hosts: production
  become: true

  tasks:
    - name: Mettre à jour le code source
      git:
        repo: 'https://github.com/1ke4real/Dashcontrol.git'
        dest: '/var/www/Dashcontrol'
        version: 'master'

    - name: Nettoyer les ressources Docker inutilisées
      command: docker system prune -f

    - name: Nettoyer les volumes Docker inutilisés
      command: docker volume prune -f

    - name: Nettoyer les réseaux Docker inutilisés
      command: docker network prune -f

    - name: Supprimer les volumes spécifiques
      shell: |
        volumes=$(docker volume ls -q)
        if [ -n "$volumes" ]; then
          docker volume rm $volumes
        else
          echo "No Docker volumes to remove."
        fi

    - name: Démarrer les conteneurs Docker
      command: make build

    - name: Installer les dépendances composer
      command: make composer-install

